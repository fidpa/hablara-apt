# ============================================================================
# Hablara APT Repository Update Workflow
# ============================================================================
# Triggered by repository_dispatch from hablara linux-build.yml / linux-arm64-build.yml.
# Downloads .deb from GitHub Release, imports into reprepro, deploys via GitHub Pages.
#
# Trigger: repository_dispatch (event_type: update-apt-repo)
# Payload: { version: "v1.2.5", arch: "amd64" | "arm64" }
#
# Secrets:
#   APT_GPG_PRIVATE_KEY - Armored GPG private key for signing
#   APT_GPG_PASSPHRASE  - Passphrase for the GPG key (optional)
#   HABLARA_REPO_TOKEN  - PAT with repo scope for downloading from fidpa/hablara releases
#
# State Persistence:
#   reprepro database (db/, dists/, pool/) is persisted on the gh-pages branch.
#   Each run checks out gh-pages, imports new .deb, re-deploys.
# ============================================================================

name: Update APT Repository

on:
  repository_dispatch:
    types: [update-apt-repo]

  # Allow manual trigger for re-importing a specific version
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.2.5)'
        required: true
        type: string
      arch:
        description: 'Architecture (amd64 or arm64)'
        required: true
        type: choice
        options:
          - amd64
          - arm64
          - both

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: apt-repo-update
  cancel-in-progress: false  # Don't cancel in-progress updates (serialized amd64 â†’ arm64)

jobs:
  update-repo:
    name: Update APT Repository
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # Checkout gh-pages branch to preserve existing reprepro state (pool/, dists/, db/)
      # Falls back to main if gh-pages doesn't exist yet (first run)
      - name: Checkout repository state
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          ref: gh-pages
          fetch-depth: 1
        continue-on-error: true
        id: checkout-ghpages

      - name: Fallback to main branch (first run)
        if: steps.checkout-ghpages.outcome == 'failure'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Determine version and architecture
        id: params
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
            ARCH="${{ github.event.client_payload.arch }}"
          else
            VERSION="${{ inputs.version }}"
            ARCH="${{ inputs.arch }}"
          fi

          # Validate version format (prevent injection from repository_dispatch)
          if ! echo "$VERSION" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "ERROR: Invalid version format: $VERSION (expected: vX.Y.Z)"
            exit 1
          fi

          # Validate architecture (prevent injection from repository_dispatch)
          if ! echo "$ARCH" | grep -qE '^(amd64|arm64|both)$'; then
            echo "ERROR: Invalid architecture: $ARCH (expected: amd64, arm64, or both)"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "arch=$ARCH" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Architecture: $ARCH"

      - name: Install reprepro
        run: sudo apt-get update && sudo apt-get install -y reprepro

      - name: Ensure reprepro config exists
        run: |
          # Create conf/ if not present (first run or fresh branch)
          mkdir -p conf
          cat > conf/distributions <<'CONF'
          Origin: Hablara
          Label: Hablara
          Codename: stable
          Architectures: amd64 arm64
          Components: main
          Description: Hablara Voice Intelligence Platform - APT Repository
          SignWith: default
          CONF
          # Remove leading whitespace from heredoc
          sed -i 's/^          //' conf/distributions

          cat > conf/options <<'CONF'
          verbose
          basedir .
          CONF
          sed -i 's/^          //' conf/options

      - name: Import GPG key
        env:
          APT_GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
          APT_GPG_PASSPHRASE: ${{ secrets.APT_GPG_PASSPHRASE }}
        run: |
          if [ -z "$APT_GPG_PRIVATE_KEY" ]; then
            echo "ERROR: APT_GPG_PRIVATE_KEY secret not configured"
            exit 1
          fi

          echo "$APT_GPG_PRIVATE_KEY" | gpg --batch --import

          # Configure gpg-agent for non-interactive signing
          mkdir -p ~/.gnupg
          echo "allow-preset-passphrase" >> ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye 2>/dev/null || true

          # If passphrase is set, cache it
          if [ -n "$APT_GPG_PASSPHRASE" ]; then
            KEY_GRIP=$(gpg --list-secret-keys --with-keygrip 2>/dev/null | grep -A1 "sec" | grep "Keygrip" | awk '{print $3}' | head -1)
            if [ -n "$KEY_GRIP" ]; then
              echo "$APT_GPG_PASSPHRASE" | /usr/lib/gnupg/gpg-preset-passphrase --preset "$KEY_GRIP"
            fi
          fi

          echo "GPG key imported successfully"
          gpg --list-secret-keys --keyid-format long

      - name: Download .deb from GitHub Release
        env:
          GH_TOKEN: ${{ secrets.HABLARA_REPO_TOKEN }}
        run: |
          VERSION="${{ steps.params.outputs.version }}"
          ARCH="${{ steps.params.outputs.arch }}"

          mkdir -p incoming

          download_deb() {
            local arch=$1
            local deb_arch
            case "$arch" in
              amd64) deb_arch="amd64" ;;
              arm64) deb_arch="arm64" ;;
              *) echo "ERROR: Unknown arch: $arch"; exit 1 ;;
            esac

            echo "Downloading .deb for ${deb_arch} from release ${VERSION}..."
            gh release download "$VERSION" \
              -R fidpa/hablara \
              -p "*_${deb_arch}.deb" \
              -D incoming/ \
              || { echo "ERROR: Failed to download .deb for $deb_arch"; exit 1; }
          }

          if [ "$ARCH" = "both" ]; then
            download_deb "amd64"
            download_deb "arm64"
          else
            download_deb "$ARCH"
          fi

          echo "Downloaded .deb files:"
          ls -lh incoming/

      - name: Import into reprepro
        run: |
          for deb in incoming/*.deb; do
            if [ -f "$deb" ]; then
              echo "Importing: $(basename "$deb")"
              # Handle duplicate versions gracefully (re-run scenario)
              reprepro --basedir . includedeb stable "$deb" || {
                echo "Warning: Import failed for $(basename "$deb"), attempting replace..."
                PKG_NAME=$(dpkg-deb --field "$deb" Package)
                reprepro --basedir . remove stable "$PKG_NAME" 2>/dev/null || true
                reprepro --basedir . includedeb stable "$deb"
              }
            fi
          done

          # Cleanup incoming
          rm -rf incoming

          echo "Repository contents:"
          reprepro --basedir . list stable

      - name: Export GPG public key
        run: |
          # Export only the signing key (not all keys in keyring)
          KEY_ID=$(gpg --list-secret-keys --keyid-format long 2>/dev/null \
            | grep "sec" | head -1 | awk '{print $2}' | cut -d'/' -f2)
          gpg --armor --export "$KEY_ID" > pubkey.asc
          gpg --export "$KEY_ID" > pubkey.gpg
          echo "Public key exported (Key ID: $KEY_ID)"

      - name: Create index page
        run: |
          cat > index.html <<'HTMLEOF'
<!DOCTYPE html>
<html>
<head><title>Hablara APT Repository</title></head>
<body>
<h1>Hablara APT Repository</h1>
<h2>Quick Setup</h2>
<pre><code>curl -fsSL https://fidpa.github.io/hablara-apt/pubkey.asc \
  | sudo gpg --dearmor -o /usr/share/keyrings/hablara-archive-keyring.gpg

echo "Types: deb
URIs: https://fidpa.github.io/hablara-apt
Suites: stable
Components: main
Architectures: amd64 arm64
Signed-By: /usr/share/keyrings/hablara-archive-keyring.gpg" \
  | sudo tee /etc/apt/sources.list.d/hablara.sources

sudo apt update && sudo apt install hablara
</code></pre>
<p>Or install from <a href="https://github.com/fidpa/hablara/releases">GitHub Releases</a> - the .deb package registers this repository automatically.</p>
</body>
</html>
HTMLEOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e  # v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          exclude_assets: '.github,incoming,*.md'
          keep_files: false
          force_orphan: false
